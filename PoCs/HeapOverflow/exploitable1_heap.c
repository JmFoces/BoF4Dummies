#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <stdint.h>

void help(){
	printf("Use example:\n");
	printf("./exploitable <selector> <params> \n");
	printf("./exploitable 1 filename ## Stack BoF && FormatString \n");
}

int read_file(char *filename, char **buffer, size_t *lSize){
	FILE * pFile;;
	size_t result;

	pFile = fopen ( filename , "rb" );
	if (pFile==NULL) {return 0;}


	fseek (pFile , 0 , SEEK_END);
	*lSize = ftell (pFile);
	rewind (pFile);


	*buffer = (char*) malloc (sizeof(char)*(*lSize));
	if (*buffer == NULL) {return 0;}


	result = fread (*buffer,1,*lSize,pFile);
	if (result != *lSize) {return 0;} 

	fclose (pFile);

	return result;
}

void flag_1(){
	printf("Pwned: Exec redirect via Data Corruption\n");
	printf("\n");
	
}

void flag_2(){
	printf("Pwned: Exec redirect via EIP Overwrite\n");
	printf("\n");
	
}

int bof_me(char *buffer, size_t lSize){
	char *vulnerable = (char*) malloc(100*sizeof(char));
	int *something = (int*)malloc(sizeof(int));
	*something=0;
	memset(vulnerable,0x99,99);
	memcpy(vulnerable, buffer, lSize-1);
	vulnerable[99]='\x00';
	if ( *something != 0 ) flag_1();
	return 0;
}


int main (int argc, char **argv) {
	if (argv[1] != NULL)
	{
		char option = argv[1][0];

		switch(option) {
			case '0':
				if ( option == '0' && option=='1' ) flag_2();
				break;

			case '1' :
				if (argv[2] != NULL){
					size_t lSize;
					char* buffer;
					size_t status_code = read_file(argv[2], &buffer, &lSize);
					if (status_code!=0){
						printf("Size: %d \n", lSize);
						printf("Contents @ %p \n",buffer);
						bof_me(buffer,lSize);
					}else{
						printf("Cannot read file %s\n",argv[2]);
					}
				}else{
					help();
				}
				break; 

			default : 
				help();
				break;
		}
	}else{
		help();
		return 1;
	}
	return (0);
}

